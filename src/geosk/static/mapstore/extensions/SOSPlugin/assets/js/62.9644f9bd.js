(self.webpackChunkSOSPlugin=self.webpackChunkSOSPlugin||[]).push([[62],{39798:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>de});var r=n(24852),a=n.n(r),l=n(77580),s=n.n(l),o=n(71703),i=n(6607),c=n(35220),u=n(7066);function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m.apply(this,arguments)}const d=(0,r.forwardRef)(((e,t)=>{let{children:n,variant:r,size:l,...s}=e;return a().createElement(u.zx,m({},s,{ref:t,bsStyle:r,bsSize:l}),n)}));function g(e){let{name:t,className:n,style:r,stylePrefix:l="fa"}=e;return a().createElement("i",{className:`${l} fa-${t}${n?` ${n}`:""}`,style:r})}g.defaultProps={};const p=g;var f=n(81067),y=n(55241),h=n.n(y),E=n(17674);(0,E.nv)("proxyUrl",{url:"proxy/?url=",useCORS:["/api/v2/sos"],autoDetectCORS:!0});const v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h().get("/api/v2/sos/sensors",{params:{...e}}).then((e=>{let{data:t}=e;return t}))},S=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h().get("/api/v2/sos/sos_service",{params:{...e}}).then((e=>{let{data:t}=e;return t}))},b=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h().get("/api/v2/sos/observable_properties",{params:{...e}}).then((e=>{let{data:t}=e;return t}))};var O=n(57952);var k=n(9509),_=n(22030);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},w.apply(this,arguments)}function x(e){let{href:t,readOnly:n,children:r,...l}=e;return n?r:a().createElement("a",w({href:t},l),r)}x.propTypes={href:s().string,readOnly:s().bool.isRequired,children:s().any},x.defaultProps={href:"",readOnly:!1};const C=x,P=(0,r.forwardRef)(((e,t)=>{let{data:n,layoutCardsStyle:l,readOnly:s,onClick:o,loading:i}=e;const[c]=(0,r.useState)(n),[m,g]=(0,r.useState)(!1),f="list"===l?"card-img-left":"card-img-top";return a().createElement("div",{ref:t,onClick:function(){o(n)},className:`geosk-resource-card${s?" read-only":""} geosk-card-type-${l} ${"list"===l?"rounded-0":""}`},a().createElement("div",{className:`card-resource-${l}`},m?a().createElement("div",{className:`${f} card-img-placeholder`}):a().createElement("img",{className:f,src:c.thumbnail_url,onError:()=>g(!0)}),a().createElement("div",{className:"geosk-resource-card-body-wrapper"},a().createElement("div",{className:"card-body"},a().createElement("div",{className:"card-title"},a().createElement("div",null,!i&&a().createElement(a().Fragment,null,a().createElement(C,{readOnly:s,href:c.sosUrl},a().createElement(p,{name:"icon"}))),a().createElement(C,{className:"geosk-card-title",readOnly:s,href:c.sosUrl},c.title),c.sensorId&&a().createElement("hr",null)),a().createElement("div",{className:"geosk-sensor-add"},a().createElement(d,{variant:"primary",size:"sm"},a().createElement(u.gG,{glyph:"plus"})))),a().createElement("p",{className:"card-text geosk-card-description"},c.sensorId)))))}));P.defaultProps={links:[],onClick:()=>{},loading:!1};const N=P;var I=n(72500),T=n.n(I),M=n(661),G=n.n(M),R=n(53849),F=n.n(R);var j=n(53256),L=n(93849),z=n(49977);const V="GEOSK:SET_COORDINATES",$="GEOSK:SET_FOIS_RESPONSE",Z="GEOSK:QUERY_COMPLETE",A="GEOSK:QUERY_BEGAN",U="GEOSK:OPEN_CLOSE_MODAL",q="GEOSK:SET_BASE_PATH",W=e=>({type:V,coordinates:e}),H=()=>({type:Z}),D=e=>({type:U,modalState:e});var K=n(30526),B=n(49586),J=n(79048),X=n(60931),Q=n(25333),Y=n(54702),ee=n.n(Y),te=n(67909);const ne={latlng:{lat:0,lng:0},loading:!1,fois:null,modalIsOpen:!1,basePath:"/geoserver/ows"};var re=n(30823);const ae=function(){return a().createElement(a().Fragment,null,a().createElement("div",{className:"spinning",role:"status"},a().createElement("span",{className:"sr-only"},"Loading...")))},le=(0,r.forwardRef)(((e,t)=>{const{loading:n,fois:l,lat:s,lng:o,iframeSrc:i,supportedOrigin:m,modalIsOpen:g,setModalIsOpen:p,modalTitle:f}=e;return(0,r.useEffect)((()=>{if(l){!g&&p(!0);const e={payload:{...l},clickCoordinates:{lat:s,lng:o}};t?.current?.contentWindow.postMessage(e,m)}}),[l]),a().createElement("div",{className:"geosk-GFI-viewer-wrapper"},a().createElement(re.s,{style:{display:g?"inline-block":"none",border:"1px solid #eee"},default:{x:50,y:100,width:800,height:400},minWidth:500,minHeight:190,bounds:"#page-map-viewer"},a().createElement("div",{className:"flexible-modal-drag-area"},a().createElement("div",{className:"flexible-modal-title"},f?a().createElement("span",null,f):a().createElement(c.Z,{msgId:"geoskViewer.modalTitle"}),n&&a().createElement(ae,null)),a().createElement(d,{className:"square-button",variant:"primary",onClick:()=>p(!1)},a().createElement(u.gG,{glyph:"1-close"}))),a().createElement("iframe",{ref:t,src:i})))})),se=(0,r.memo)(le),oe=e=>{let{lat:t,lng:n,iframeSrc:r,loading:l,fois:s,supportedOrigin:o,modalIsOpen:i,onOpenCloseModal:c,modalTitle:u}=e;const m=a().createRef();return a().createElement(se,{lat:t,lng:n,iframeSrc:r,loading:l,fois:s,ref:m,supportedOrigin:o,modalIsOpen:i,setModalIsOpen:c,modalTitle:u})};function ie(){return ie=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},ie.apply(this,arguments)}const ce=(0,f.Z)("placeholder")(u.NI);function ue(e){let{onChange:t,value:n,...r}=e;return a().createElement(ce,ie({type:"text"},r,{value:n,onChange:e=>t(e.target.value)}))}function me(e){let{request:t,onAdd:n,onClose:l,onZoomTo:s,placeholderId:o}=e;const[i,m]=(0,r.useState)(!1),[g,f]=(0,r.useState)([]),[y,h]=(0,r.useState)([]),[k,_]=(0,r.useState)([]),[w,x]=(0,r.useState)({observable_property:"",sensor_title:""}),[C,P]=(0,r.useState)(0),{observable_property:I,sensor_title:M}=w,R=(0,r.useRef)(),[j,L]=(0,r.useState)(1),[z,V]=(0,r.useState)(!1),[$,Z]=(0,r.useState)(""),A=(0,r.useRef)(),U=(0,r.useRef)();(0,r.useEffect)((function(){return m(!0),L(1),U.current({page:1,page_size:7,reset:!0}),b().then((e=>_(e.layers))),S().then((e=>h(e.services))),()=>f([])}),[]),(e=>{let{scrollContainer:t,shouldScroll:n=(()=>!0),onLoad:a,offset:l=200}=e;const s=(0,r.useRef)({});s.current=()=>{(t?t.scrollTop:document.body.scrollTop||document.documentElement.scrollTop)+(t?t.clientHeight:window.innerHeight)>=(t?t.scrollHeight:document.body.scrollHeight||document.documentElement.scrollHeight)-l&&n()&&a()},(0,r.useEffect)((()=>{let e=t||window;function n(){s.current()}return e.addEventListener("scroll",n),()=>{e.removeEventListener("scroll",n)}}),[t])})({scrollContainer:R.current,shouldScroll:()=>!i&&z,onLoad:()=>{L(j+1)}}),U.current=e=>{!i&&t&&(R.current&&e.reset&&(R.current.scrollTop=0),m(!0),t({...$.length>0&&{sensor_name:$},...I.length>0&&{observable_property:I},...M.length>0&&{sensor_title:M},page:e.page,page_size:e.page_size}).then((t=>{if(A.current){const n=t.layers;f(1===e.page?n:[...g,...n]),m(!1),P(t.total);const r=t.total>g.length;V(r)}})).catch((()=>{A.current&&m(!1),V(!1)})))},(0,r.useEffect)((function(){return A.current=!0,()=>{A.current=!1}}),[]),(0,r.useEffect)((function(){j>1&&(C>g.length?U.current({page:j,page_size:7}):V(!1))}),[j]);const q=e=>t=>{const n=t.target.value;x({...w,[e]:n})};return(0,r.useEffect)((()=>{I.length>0&&S({observable_property:I}).then((e=>h(e.services))),M.length>0&&b({sos_url:M}).then((e=>_(e.layers)))}),[w]),a().createElement("div",{className:"extension"},a().createElement("div",{className:"geosk-extension-head"},a().createElement("div",null,a().createElement(u.gG,{glyph:"folder-open"})),a().createElement("div",{className:"geosk-sensors-catalog-title"},a().createElement("h4",null,a().createElement(c.Z,{msgId:"geoskViewer.sensorCatalogue"}))),a().createElement("div",null,a().createElement(d,{className:"square-button",style:{background:"transparent",color:"#fff"},onClick:l},a().createElement(u.gG,{glyph:"1-close"})))),a().createElement("div",{className:"geosk-extension-body"},a().createElement("div",{className:"geosk-filters"},a().createElement("div",{className:"geosk-sensors-catalog-filter input-group"},a().createElement(ue,{className:"form-control",placeholder:o,value:$,onChange:e=>Z(e)}),i?a().createElement(O.Z,{size:2}):a().createElement("span",{className:"input-group-btn"},a().createElement(d,{className:"btn-sk",onClick:()=>Z("")},a().createElement(p,{name:"times"})))),a().createElement("div",{className:"form-group"},a().createElement("select",{className:"form-control",onChange:q("observable_property")},a().createElement("option",{value:""},"Choose an Observable Property"),k?.length>0&&k?.map((e=>a().createElement("option",{key:e.sensor_name,value:e.definition},e.property_label))))),a().createElement("div",{className:"form-group"},a().createElement("select",{className:"form-control",onChange:q("sensor_title")},a().createElement("option",{value:""},"Choose a SOS Service"),y?.length>0&&y?.map((e=>a().createElement("option",{key:e.id,value:e.online_resource},e.title))))),a().createElement("div",null,a().createElement(d,{variant:"primary",size:"sm",type:"submit",onClick:e=>{e.preventDefault(),m(!0),v({...$.length>0&&{sensor_name:$},...I.length>0&&{observable_property:I},...M.length>0&&{sensor_title:M}}).then((e=>(f(e.layers),m(!1)))).catch((()=>(f([]),m(!1))))}},a().createElement(c.Z,{msgId:"geoskViewer.search"})))),a().createElement("div",{ref:R,className:"geosk-sensors-catalog-body"},a().createElement("ul",{className:"geosk-sensors-catalog-list"},g?.map((e=>a().createElement("li",{key:e.pk},a().createElement(N,{data:e,readOnly:!0,layoutCardsStyle:"list",onClick:()=>function(e){const t=(e=>{const{alternate:t,links:n=[],featureinfo_custom_template:r,title:a,perms:l,pk:s,has_time:o,default_style:i,ptype:c}=e,u=function(e){let{ll_bbox_polygon:t}=e;if(!t)return null;const n=G()({type:"Feature",properties:{},geometry:t}),[r,a,l,s]=n;return{crs:"EPSG:4326",bounds:{minx:r,miny:a,maxx:l,maxy:s}}}(e),m=i&&{defaultStyle:{title:i.sld_title,name:i.workspace?`${i.workspace}:${i.name}`:i.name}},d={pk:s,mapLayer:{dataset:e},isSOSLayer:!0,...m};switch(c){case"gxp_arcrestsource":case"gxp_arcrestsource":{const{url:e}=n.find((e=>{let{mime:t,link_type:n}=e;return"text/html"===t&&"image"===n}))||{};return{perms:l,id:`SOS:${F()()}`,pk:s,type:"arcgis",name:t.replace("remoteWorkspace:",""),url:e,...u&&{bbox:u},title:a,visibility:!0,extendedParams:d}}default:const{url:e}=n.find((e=>{let{link_type:t}=e;return"OGC:WFS"===t}))||{},{url:i}=n.find((e=>{let{link_type:t}=e;return"OGC:WMS"===t}))||{},{url:c}=n.find((e=>{let{link_type:t}=e;return"OGC:WMTS"===t}))||{},g=[...o?[{name:"time",source:{type:"multidim-extension",url:c||(i||"").split("/geoserver/")[0]+"/geoserver/gwc/service/wmts"}}]:[]],p=i&&T().parse(i,!0).query,{defaultLayerFormat:f="image/png",defaultTileSize:y=512}=(0,E.u8)("geoNodeSettings")||{};return{perms:l,id:`SOS:${F()()}`,pk:s,type:"wms",name:t,url:i||"",format:f,...e&&{search:{type:"wfs",url:e}},...u&&{bbox:u},...r&&{featureInfo:{format:"TEMPLATE",template:r}},style:m?.defaultStyle?.name||"",title:a,tileSize:y,visibility:!0,...p&&{params:p},...g.length>0&&{dimensions:g},extendedParams:d}}})(e);t.featureInfo={...t.featureInfo,viewer:{type:"SosGFIViewer"},format:"PROPERTIES"},n(t);const{minx:r,miny:a,maxx:l,maxy:o}=t?.bbox?.bounds||{},i=t?.bbox?.bounds&&[r,a,l,o];i&&s(i,t?.bbox?.crs)}(e)})))),0===g?.length&&!i&&a().createElement("div",{className:"geosk-sensors-catalog-alert"},a().createElement(c.Z,{msgId:"geoskViewer.sosCatalogEntriesNoResults"})))),i&&0===g?.length&&a().createElement("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.8)",zIndex:2,display:"flex",alignItems:"center",justifyContent:"center"}},a().createElement(O.Z,{size:70}))))}me.propTypes={request:s().func,onAdd:s().func,placeholderId:s().string,onClose:s().func,onZoomTo:s().func},me.defaultProps={request:v,onAdd:()=>{},placeholderId:"geoskViewer.SearchSensors",onZoomTo:()=>{},onClose:()=>{}};const de={name:"SOSPlugin",component:(0,o.connect)((0,i.P1)([e=>e.controls?.SOSPlugin?.enabled||!1,e=>e.geoskSOSPlugin?.latlng?.lat||e.clickPoint?.latlng?.lat||0,e=>e.geoskSOSPlugin?.latlng?.lng||e.clickPoint?.latlng?.lng||0,e=>e.geoskSOSPlugin?.loading||!1,e=>e.geoskSOSPlugin?.fois||null,e=>e.geoskSOSPlugin?.modalIsOpen||!1],((e,t,n,r,a,l)=>({enabled:e,lat:t,lng:n,loading:r,fois:a,modalIsOpen:l}))),{onAdd:k.A4,onClose:j.Xg.bind(null,"SOSPlugin","enabled",!1),onZoomTo:_.Px,onError:K.vU,onOpenCloseModal:D,onSetBasePath:e=>({type:q,url:e})})((e=>{let{enabled:t,lat:n,lng:l,iframeSrc:s,supportedOrigin:o,loading:i,fois:c,modalIsOpen:u,onOpenCloseModal:m,modalTitle:d,onSetBasePath:g,basePath:p,...f}=e;return(0,r.useEffect)((()=>{g(p)}),[p]),a().createElement("div",null,t&&a().createElement(me,f),i&&a().createElement("style",{dangerouslySetInnerHTML:{__html:"\n              #map > div {\n                cursor: wait !important;\n              }\n            "}}),a().createElement(oe,{lat:n,lng:l,iframeSrc:s,supportedOrigin:o,loading:i,fois:c,modalIsOpen:u,onOpenCloseModal:m,modalTitle:d}))})),reducers:{geoskSOSPlugin:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ne,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case V:{const n=t.coordinates,r=Math.round(1e5*n.lat)/1e5,a=Math.round(1e5*n.lng)/1e5;return{...e,latlng:{lat:r,lng:a}}}case $:{const{fois:n}=t;return{...e,fois:n}}case A:return{...e,loading:!0};case Z:return{...e,loading:!1};case U:return{...e,modalIsOpen:t.modalState};case q:return{...e,basePath:t.url};default:return e}}},epics:{closeSensorCatalogOnMapClick:(e,t)=>e.ofType(_.TR).filter((()=>!0===t.getState().controls?.SOSPlugin?.enabled)).switchMap((()=>z.Observable.of((0,j.Xg)("SOSPlugin","enabled",!1)))),getFOIsFromFeatureInfo:(e,t)=>{let{getState:n=(()=>{})}=t;return e.ofType(_.TR).filter((()=>((0,J.l2)(n())?.filter((e=>"background"!==e.group&&"SosGFIViewer"===e.featureInfo?.viewer?.type))?.map((e=>e.name))||[]).length>0)).switchMap((e=>{let{point:t}=e;const r=n(),a=t.latlng,l=(0,Q.Od)(r),s=[101,101],o=ee()(l.resolution)?(0,te.getCurrentResolution)(Math.ceil(l.zoom),0,21,96):l.resolution;let i=t.latlng.lng;const c={x:i-360*Math.floor(i/360+.5),y:t.latlng.lat};let u=(0,X.oq)(c,"EPSG:4326",l.projection),m=(0,X.WJ)(u,o,0,s,null);const d=(0,J.l2)(r)?.filter((e=>"background"!==e.group&&"SosGFIViewer"===e.featureInfo?.viewer?.type))?.map((e=>e.name)),g=r.geoskSOSPlugin.basePath||"/geoserver/ows";return z.Observable.defer((()=>h().get(g,{params:{service:"WMS",version:"1.1.1",request:"GetFeatureInfo",exceptions:B.O7.JSON,layers:d.join(","),height:101,width:101,srs:l.projection,bbox:m.minx+","+m.miny+","+m.maxx+","+m.maxy,feature_count:10,info_format:B.O7.JSON,query_layers:d.join(","),styles:"",x:Math.ceil(50.5),y:Math.ceil(50.5),access_token:r.security.token}}).then((e=>e.data)))).switchMap((e=>{const t=[],n=[];return e.features?.forEach((e=>{let{properties:r}=e;t.push(r.id),n.push(r.resource_id)})),t.length>0&&n.length>0?z.Observable.defer((()=>function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h().get("/api/v2/sos/fois",{params:{...e}}).then((e=>{let{data:t}=e;return t}))}({id:[t.join(",")],sensor_id:[n.join(",")]}))).switchMap((e=>z.Observable.of(W(a),{type:$,fois:e},H(),D(!0)))):e.exceptions?z.Observable.of((0,K.vU)({title:"geoskViewer.error",message:"geoskViewer.noFOIsForLayer"}),H(),D(!1)):z.Observable.of(W(a),H(),(0,K.vU)({title:"geoskViewer.noFeaturesFound",message:"geoskViewer.noSOSInfo"}),D(!1))})).catch((e=>z.Observable.of((0,K.vU)({title:"geoskViewer.error",message:e?.data?.detail||e?.originalError?.message||e?.message||"geoskViewer.actionFailed"}),H(),D(!1)))).startWith({type:A})}))}},containers:{BurgerMenu:{name:"SOSPlugin",position:40,text:a().createElement(c.Z,{msgId:"geoskViewer.sensorCatalogue"}),icon:a().createElement(u.gG,{glyph:"folder-open"}),action:j.Xg.bind(null,"SOSPlugin","enabled",!0),selector:(0,i.P1)(L.jl,(e=>({style:e?{}:{display:"none"}})))}}}},57058:(e,t,n)=>{var r={"./cesium/Layers":73039,"./leaflet/Layers":81842,"./openlayers/Layers":66832};function a(e){var t=l(e);return n(t)}function l(e){if(!n.o(r,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return r[e]}a.keys=function(){return Object.keys(r)},a.resolve=l,e.exports=a,a.id=57058},45968:()=>{}}]);