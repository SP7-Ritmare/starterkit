(self.webpackChunkSOSPlugin=self.webpackChunkSOSPlugin||[]).push([[69],{81912:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>ue});var l=n(24852),r=n.n(l),a=n(77580),o=n.n(a),s=n(71703),i=n(6607),c=n(35220),u=n(7066);function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e},d.apply(this,arguments)}const m=(0,l.forwardRef)(((e,t)=>{let{children:n,variant:l,size:a,...o}=e;return r().createElement(u.zx,d({},o,{ref:t,bsStyle:l,bsSize:a}),n)}));function g(e){let{name:t,className:n,style:l,stylePrefix:a="fa"}=e;return r().createElement("i",{className:"".concat(a," fa-").concat(t).concat(n?" ".concat(n):""),style:l})}g.defaultProps={};const p=g;var v=n(81067),f=n(55241),y=n.n(f),h=n(17674);(0,h.nv)("proxyUrl",{url:"proxy/?url=",useCORS:["/api/v2/sos"],autoDetectCORS:!0});const E=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return y().get("/api/v2/sos/sensors",{params:{...e}}).then((e=>{let{data:t}=e;return t}))},S=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return y().get("/api/v2/sos/sos_service",{params:{...e}}).then((e=>{let{data:t}=e;return t}))},b=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return y().get("/api/v2/sos/observable_properties",{params:{...e}}).then((e=>{let{data:t}=e;return t}))};var O=n(57952);var k=n(9509),_=n(22030);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e},w.apply(this,arguments)}function P(e){let{href:t,readOnly:n,children:l,...a}=e;return n?l:r().createElement("a",w({href:t},a),l)}P.propTypes={href:o().string,readOnly:o().bool.isRequired,children:o().any},P.defaultProps={href:"",readOnly:!1};const C=P,x=(0,l.forwardRef)(((e,t)=>{let{data:n,layoutCardsStyle:a,readOnly:o,onClick:s,loading:i}=e;const[c]=(0,l.useState)(n),[d,g]=(0,l.useState)(!1),v="list"===a?"card-img-left":"card-img-top";return r().createElement("div",{ref:t,onClick:function(){s(n)},className:"geosk-resource-card".concat(o?" read-only":""," geosk-card-type-").concat(a," ").concat("list"===a?"rounded-0":"")},r().createElement("div",{className:"card-resource-".concat(a)},d?r().createElement("div",{className:"".concat(v," card-img-placeholder")}):r().createElement("img",{className:v,src:c.thumbnail_url,onError:()=>g(!0)}),r().createElement("div",{className:"geosk-resource-card-body-wrapper"},r().createElement("div",{className:"card-body"},r().createElement("div",{className:"card-title"},r().createElement("div",null,!i&&r().createElement(r().Fragment,null,r().createElement(C,{readOnly:o,href:c.sosUrl},r().createElement(p,{name:"icon"}))),r().createElement(C,{className:"geosk-card-title",readOnly:o,href:c.sosUrl},c.title),c.sensorId&&r().createElement("hr",null)),r().createElement("div",{className:"geosk-sensor-add"},r().createElement(m,{variant:"primary",size:"sm"},r().createElement(u.gG,{glyph:"plus"})))),r().createElement("p",{className:"card-text geosk-card-description"},c.sensorId)))))}));x.defaultProps={links:[],onClick:()=>{},loading:!1};const N=x;var I=n(72500),T=n.n(I),M=n(661),G=n.n(M),R=n(53849),F=n.n(R);var L=n(53256),z=n(93849),j=n(49977);const V="GEOSK:SET_COORDINATES",A="GEOSK:SET_FOIS_RESPONSE",Z="GEOSK:QUERY_COMPLETE",U="GEOSK:QUERY_BEGAN",q="GEOSK:OPEN_CLOSE_MODAL",W="GEOSK:SET_BASE_PATH",H=e=>({type:V,coordinates:e}),K=()=>({type:Z});var D=n(30526),B=n(6042),J=n(41768),X=n(14303),Q=n(25333),Y=n(54702),$=n.n(Y);const ee={latlng:{lat:0,lng:0},loading:!1,fois:null,modalIsOpen:!1,basePath:"/geoserver/ows"};var te=n(73944);const ne=function(){return r().createElement(r().Fragment,null,r().createElement("div",{className:"spinning",role:"status"},r().createElement("span",{className:"sr-only"},"Loading...")))},le=(0,l.forwardRef)(((e,t)=>{const{loading:n,fois:a,lat:o,lng:s,iframeSrc:i,supportedOrigin:d,modalIsOpen:g,setModalIsOpen:p,modalTitle:v}=e;return(0,l.useEffect)((()=>{if(a){var e;!g&&p(!0);const n={payload:{...a},clickCoordinates:{lat:o,lng:s}};null==t||null===(e=t.current)||void 0===e||e.contentWindow.postMessage(n,d)}}),[a]),r().createElement("div",{className:"geosk-GFI-viewer-wrapper"},r().createElement(te.s,{style:{display:g?"inline-block":"none",border:"1px solid #eee"},default:{x:50,y:100,width:800,height:400},minWidth:500,minHeight:190,bounds:"#page-map-viewer"},r().createElement("div",{className:"flexible-modal-drag-area"},r().createElement("div",{className:"flexible-modal-title"},v?r().createElement("span",null,v):r().createElement(c.Z,{msgId:"geoskViewer.modalTitle"}),n&&r().createElement(ne,null)),r().createElement(m,{className:"square-button",variant:"primary",onClick:()=>p(!1)},r().createElement(u.gG,{glyph:"1-close"}))),r().createElement("iframe",{ref:t,src:i})))})),re=(0,l.memo)(le),ae=e=>{let{lat:t,lng:n,iframeSrc:l,loading:a,fois:o,supportedOrigin:s,modalIsOpen:i,onOpenCloseModal:c,modalTitle:u}=e;const d=r().createRef();return r().createElement(re,{lat:t,lng:n,iframeSrc:l,loading:a,fois:o,ref:d,supportedOrigin:s,modalIsOpen:i,setModalIsOpen:c,modalTitle:u})};function oe(){return oe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e},oe.apply(this,arguments)}const se=(0,v.Z)("placeholder")(u.NI);function ie(e){let{onChange:t,value:n,...l}=e;return r().createElement(se,oe({type:"text"},l,{value:n,onChange:e=>t(e.target.value)}))}function ce(e){let{request:t,page_size:n,onAdd:a,onClose:o,onZoomTo:s,placeholderId:i}=e;const[d,g]=(0,l.useState)(!1),[v,f]=(0,l.useState)([]),[y,k]=(0,l.useState)([]),[_,w]=(0,l.useState)([]),[P,C]=(0,l.useState)({observable_property:"",sensor_title:""}),[x,I]=(0,l.useState)(0),{observable_property:M,sensor_title:R}=P,L=(0,l.useRef)(),[z,j]=(0,l.useState)(1),[V,A]=(0,l.useState)(!1),[Z,U]=(0,l.useState)(""),q=(0,l.useRef)();(0,l.useEffect)((function(){return g(!0),j(1),W.current({page:1,page_size:7,reset:!0}),b().then((e=>w(e.layers))),S().then((e=>k(e.services))),()=>f([])}),[]),(e=>{let{scrollContainer:t,shouldScroll:n=(()=>!0),onLoad:r,offset:a=200}=e;const o=(0,l.useRef)({});o.current=()=>{(t?t.scrollTop:document.body.scrollTop||document.documentElement.scrollTop)+(t?t.clientHeight:window.innerHeight)>=(t?t.scrollHeight:document.body.scrollHeight||document.documentElement.scrollHeight)-a&&n()&&r()},(0,l.useEffect)((()=>{let e=t||window;function n(){o.current()}return e.addEventListener("scroll",n),()=>{e.removeEventListener("scroll",n)}}),[t])})({scrollContainer:L.current,shouldScroll:()=>!d&&V,onLoad:()=>{j(z+1)}});const W=(0,l.useRef)();W.current=e=>{!d&&t&&(L.current&&e.reset&&(L.current.scrollTop=0),g(!0),t({...Z.length>0&&{sensor_name:Z},...M.length>0&&{observable_property:M},...R.length>0&&{sensor_title:R},page:e.page,page_size:e.page_size}).then((t=>{if(q.current){const n=t.layers;f(1===e.page?n:[...v,...n]),g(!1),I(t.total);const l=t.total>v.length;A(l)}})).catch((()=>{q.current&&g(!1),A(!1)})))},(0,l.useEffect)((function(){return q.current=!0,()=>{q.current=!1}}),[]),(0,l.useEffect)((function(){z>1&&(x>v.length?W.current({page:z,page_size:7}):A(!1))}),[z]);const H=e=>t=>{const n=t.target.value;C({...P,[e]:n})};return(0,l.useEffect)((()=>{M.length>0&&S({observable_property:M}).then((e=>k(e.services))),R.length>0&&b({sos_url:R}).then((e=>w(e.layers)))}),[P]),r().createElement("div",{className:"extension"},r().createElement("div",{className:"geosk-extension-head"},r().createElement("div",null,r().createElement(u.gG,{glyph:"folder-open"})),r().createElement("div",{className:"geosk-sensors-catalog-title"},r().createElement("h4",null,r().createElement(c.Z,{msgId:"geoskViewer.sensorCatalogue"}))),r().createElement("div",null,r().createElement(m,{className:"square-button",style:{background:"transparent",color:"#fff"},onClick:o},r().createElement(u.gG,{glyph:"1-close"})))),r().createElement("div",{className:"geosk-extension-body"},r().createElement("div",{className:"geosk-filters"},r().createElement("div",{className:"geosk-sensors-catalog-filter input-group"},r().createElement(ie,{className:"form-control",placeholder:i,value:Z,onChange:e=>U(e)}),d?r().createElement(O.Z,{size:2}):r().createElement("span",{className:"input-group-btn"},r().createElement(m,{className:"btn-sk",onClick:()=>U("")},r().createElement(p,{name:"times"})))),r().createElement("div",{className:"form-group"},r().createElement("select",{className:"form-control",onChange:H("observable_property")},r().createElement("option",{value:""},"Choose an Observable Property"),(null==_?void 0:_.length)>0&&(null==_?void 0:_.map((e=>r().createElement("option",{key:e.sensor_name,value:e.definition},e.property_label)))))),r().createElement("div",{className:"form-group"},r().createElement("select",{className:"form-control",onChange:H("sensor_title")},r().createElement("option",{value:""},"Choose a SOS Service"),(null==y?void 0:y.length)>0&&(null==y?void 0:y.map((e=>r().createElement("option",{key:e.id,value:e.online_resource},e.title)))))),r().createElement("div",null,r().createElement(m,{variant:"primary",size:"sm",type:"submit",onClick:e=>{e.preventDefault(),g(!0),E({...Z.length>0&&{sensor_name:Z},...M.length>0&&{observable_property:M},...R.length>0&&{sensor_title:R}}).then((e=>(f(e.layers),g(!1)))).catch((()=>(f([]),g(!1))))}},r().createElement(c.Z,{msgId:"geoskViewer.search"})))),r().createElement("div",{ref:L,className:"geosk-sensors-catalog-body"},r().createElement("ul",{className:"geosk-sensors-catalog-list"},null==v?void 0:v.map((e=>r().createElement("li",{key:e.pk},r().createElement(N,{data:e,readOnly:!0,layoutCardsStyle:"list",onClick:()=>function(e){var t,n;const l=(e=>{var t;const{alternate:n,links:l=[],featureinfo_custom_template:r,title:a,perms:o,pk:s,has_time:i,default_style:c,ptype:u}=e,d=function(e){let{ll_bbox_polygon:t}=e;if(!t)return null;const n=G()({type:"Feature",properties:{},geometry:t}),[l,r,a,o]=n;return{crs:"EPSG:4326",bounds:{minx:l,miny:r,maxx:a,maxy:o}}}(e),m=c&&{defaultStyle:{title:c.sld_title,name:c.workspace?"".concat(c.workspace,":").concat(c.name):c.name}},g={pk:s,mapLayer:{dataset:e},isSOSLayer:!0,...m};switch(u){case"gxp_arcrestsource":case"gxp_arcrestsource":{const{url:e}=l.find((e=>{let{mime:t,link_type:n}=e;return"text/html"===t&&"image"===n}))||{};return{perms:o,id:"SOS:".concat(F()()),pk:s,type:"arcgis",name:n.replace("remoteWorkspace:",""),url:e,...d&&{bbox:d},title:a,visibility:!0,extendedParams:g}}default:const{url:e}=l.find((e=>{let{link_type:t}=e;return"OGC:WFS"===t}))||{},{url:c}=l.find((e=>{let{link_type:t}=e;return"OGC:WMS"===t}))||{},{url:u}=l.find((e=>{let{link_type:t}=e;return"OGC:WMTS"===t}))||{},p=[...i?[{name:"time",source:{type:"multidim-extension",url:u||(c||"").split("/geoserver/")[0]+"/geoserver/gwc/service/wmts"}}]:[]],v=c&&T().parse(c,!0).query,{defaultLayerFormat:f="image/png",defaultTileSize:y=512}=(0,h.u8)("geoNodeSettings")||{};return{perms:o,id:"SOS:".concat(F()()),pk:s,type:"wms",name:n,url:c||"",format:f,...e&&{search:{type:"wfs",url:e}},...d&&{bbox:d},...r&&{featureInfo:{format:"TEMPLATE",template:r}},style:(null==m||null===(t=m.defaultStyle)||void 0===t?void 0:t.name)||"",title:a,tileSize:y,visibility:!0,...v&&{params:v},...p.length>0&&{dimensions:p},extendedParams:g}}})(e);l.featureInfo={...l.featureInfo,viewer:{type:"SosGFIViewer"},format:"PROPERTIES"},a(l);const{minx:r,miny:o,maxx:i,maxy:c}=(null==l||null===(t=l.bbox)||void 0===t?void 0:t.bounds)||{},u=(null==l||null===(n=l.bbox)||void 0===n?void 0:n.bounds)&&[r,o,i,c];var d;u&&s(u,null==l||null===(d=l.bbox)||void 0===d?void 0:d.crs)}(e)})))),0===(null==v?void 0:v.length)&&!d&&r().createElement("div",{className:"geosk-sensors-catalog-alert"},r().createElement(c.Z,{msgId:"geoskViewer.sosCatalogEntriesNoResults"})))),d&&0===(null==v?void 0:v.length)&&r().createElement("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.8)",zIndex:2,display:"flex",alignItems:"center",justifyContent:"center"}},r().createElement(O.Z,{size:70}))))}ce.propTypes={request:o().func,page_size:o().number,onAdd:o().func,placeholderId:o().string,onClose:o().func,onZoomTo:o().func},ce.defaultProps={request:E,page_size:4,onAdd:()=>{},placeholderId:"geoskViewer.SearchSensors",onZoomTo:()=>{},onClose:()=>{}};const ue={name:"SOSPlugin",component:(0,s.connect)((0,i.P1)([e=>{var t,n;return(null===(t=e.controls)||void 0===t||null===(n=t.SOSPlugin)||void 0===n?void 0:n.enabled)||!1},e=>{var t,n,l,r;return(null===(t=e.geoskSOSPlugin)||void 0===t||null===(n=t.latlng)||void 0===n?void 0:n.lat)||(null===(l=e.clickPoint)||void 0===l||null===(r=l.latlng)||void 0===r?void 0:r.lat)||0},e=>{var t,n,l,r;return(null===(t=e.geoskSOSPlugin)||void 0===t||null===(n=t.latlng)||void 0===n?void 0:n.lng)||(null===(l=e.clickPoint)||void 0===l||null===(r=l.latlng)||void 0===r?void 0:r.lng)||0},e=>{var t;return(null===(t=e.geoskSOSPlugin)||void 0===t?void 0:t.loading)||!1},e=>{var t;return(null===(t=e.geoskSOSPlugin)||void 0===t?void 0:t.fois)||null},e=>{var t;return(null===(t=e.geoskSOSPlugin)||void 0===t?void 0:t.modalIsOpen)||!1}],((e,t,n,l,r,a)=>({enabled:e,lat:t,lng:n,loading:l,fois:r,modalIsOpen:a}))),{onAdd:k.A4,onClose:L.Xg.bind(null,"SOSPlugin","enabled",!1),onZoomTo:_.Px,onError:D.vU,onOpenCloseModal:e=>({type:"GEOSK:OPEN_CLOSE_MODAL",modalState:e}),onSetBasePath:e=>({type:"GEOSK:SET_BASE_PATH",url:e})})((e=>{let{enabled:t,lat:n,lng:a,iframeSrc:o,supportedOrigin:s,loading:i,fois:c,modalIsOpen:u,onOpenCloseModal:d,modalTitle:m,onSetBasePath:g,basePath:p,...v}=e;return(0,l.useEffect)((()=>{g(p)}),[p]),r().createElement("div",null,t&&r().createElement(ce,v),r().createElement(ae,{lat:n,lng:a,iframeSrc:o,supportedOrigin:s,loading:i,fois:c,modalIsOpen:u,onOpenCloseModal:d,modalTitle:m}))})),reducers:{geoskSOSPlugin:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ee,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case V:{const n=t.coordinates,l=Math.round(1e5*n.lat)/1e5,r=Math.round(1e5*n.lng)/1e5;return{...e,latlng:{lat:l,lng:r}}}case A:{const{fois:n}=t;return{...e,fois:n}}case U:return{...e,loading:!0};case Z:return{...e,loading:!1};case q:return{...e,modalIsOpen:t.modalState};case W:return{...e,basePath:t.url};default:return e}}},epics:{closeSensorCatalogOnMapClick:(e,t)=>e.ofType(_.TR).filter((()=>{var e,n;return!0===(null===(e=t.getState().controls)||void 0===e||null===(n=e.SOSPlugin)||void 0===n?void 0:n.enabled)})).switchMap((()=>j.Observable.of((0,L.Xg)("SOSPlugin","enabled",!1)))),getFOIsFromFeatureInfo:(e,t)=>{let{getState:n=(()=>{})}=t;return e.ofType(_.TR).filter((()=>{var e,t,l,r;const a=(null===(e=(0,J.l2)(n()))||void 0===e||null===(t=e.filter((e=>{var t,n;return"background"!==e.group&&"SosGFIViewer"===(null===(t=e.featureInfo)||void 0===t||null===(n=t.viewer)||void 0===n?void 0:n.type)})))||void 0===t?void 0:t.map((e=>e.name)))||[];return(null===(l=n())||void 0===l||null===(r=l.security)||void 0===r?void 0:r.user)&&a.length>0})).switchMap((e=>{var t,l;let{point:r}=e;const a=n(),o=r.latlng,s=(0,Q.Od)(a),i=[101,101],c=$()(s.resolution)?getCurrentResolution(Math.ceil(s.zoom),0,21,96):s.resolution;let u=r.latlng.lng;const d={x:u-360*Math.floor(u/360+.5),y:r.latlng.lat};let m=(0,X.oq)(d,"EPSG:4326",s.projection),g=(0,X.WJ)(m,c,0,i,null);const p=null===(t=(0,J.l2)(a))||void 0===t||null===(l=t.filter((e=>{var t,n;return"background"!==e.group&&"SosGFIViewer"===(null===(t=e.featureInfo)||void 0===t||null===(n=t.viewer)||void 0===n?void 0:n.type)})))||void 0===l?void 0:l.map((e=>e.name)),v=a.geoskSOSPlugin.basePath||"/geoserver/ows";return j.Observable.defer((()=>y().get(v,{params:{service:"WMS",version:"1.1.1",request:"GetFeatureInfo",exceptions:B.O7.JSON,layers:p.join(","),height:101,width:101,srs:s.projection,bbox:g.minx+","+g.miny+","+g.maxx+","+g.maxy,feature_count:10,info_format:B.O7.JSON,query_layers:p.join(","),styles:"",x:Math.ceil(50.5),y:Math.ceil(50.5),access_token:a.security.token}}).then((e=>e.data)))).switchMap((e=>{var t;const n=[],l=[];return null===(t=e.features)||void 0===t||t.forEach((e=>{let{properties:t}=e;n.push(t.id),l.push(t.resource_id)})),n.length>0&&l.length>0?j.Observable.defer((()=>function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return y().get("/api/v2/sos/fois",{params:{...e}}).then((e=>{let{data:t}=e;return t}))}({id:n,sensor_id:l}))).switchMap((e=>j.Observable.of(H(o),{type:A,fois:e},K()))):e.exceptions?j.Observable.of((0,D.vU)({title:"geoskViewer.error",message:"geoskViewer.noFOIsForLayer"}),K()):j.Observable.of(H(o),K(),(0,D.vU)({title:"geoskViewer.noFeaturesFound",message:"geoskViewer.noSOSInfo"}))})).catch((e=>{var t,n;return j.Observable.of((0,D.vU)({title:"geoskViewer.error",message:(null==e||null===(t=e.data)||void 0===t?void 0:t.detail)||(null==e||null===(n=e.originalError)||void 0===n?void 0:n.message)||(null==e?void 0:e.message)||"geoskViewer.actionFailed"}),K())})).startWith({type:U},{type:q,modalState:!0})}))}},containers:{BurgerMenu:{name:"SOSPlugin",position:40,text:r().createElement(c.Z,{msgId:"geoskViewer.sensorCatalogue"}),icon:r().createElement(u.gG,{glyph:"folder-open"}),action:L.Xg.bind(null,"SOSPlugin","enabled",!0),selector:(0,i.P1)(z.jl,(e=>({style:e?{}:{display:"none"}})))}}}},57058:(e,t,n)=>{var l={"./cesium/Layers":73039,"./leaflet/Layers":81842,"./openlayers/Layers":66832};function r(e){var t=a(e);return n(t)}function a(e){if(!n.o(l,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return l[e]}r.keys=function(){return Object.keys(l)},r.resolve=a,e.exports=r,r.id=57058},45968:()=>{}}]);